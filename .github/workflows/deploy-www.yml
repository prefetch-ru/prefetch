name: Deploy WWW to Main Bucket

on:
  push:
    branches:
      - main
    paths:
      - 'www/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    # Skip if commit message contains [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Install AWS CLI
        run: pip install awscli
      
      - name: Configure AWS CLI for Yandex Cloud
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.YANDEX_STORAGE_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_STORAGE_SECRET_KEY }}
        run: |
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region ru-central1
      
      - name: Show changed files
        run: |
          echo "üìÅ Files in www/:"
          ls -la www/
      
      - name: Minify index.html
        run: |
          echo "üî® Minifying www/index.html..."
          
          # –†–∞–∑–º–µ—Ä –¥–æ –º–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏
          BEFORE=$(stat -c%s www/index.html)
          echo "üìÑ Before: $BEFORE bytes"
          
          # –ú–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è HTML
          npx --yes html-minifier-terser \
            --collapse-whitespace \
            --remove-comments \
            --remove-redundant-attributes \
            --remove-script-type-attributes \
            --remove-style-link-type-attributes \
            --minify-css true \
            --minify-js true \
            --input-dir www \
            --output-dir www \
            --file-ext html
          
          # –†–∞–∑–º–µ—Ä –ø–æ—Å–ª–µ –º–∏–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏
          AFTER=$(stat -c%s www/index.html)
          SAVED=$((BEFORE - AFTER))
          PERCENT=$((SAVED * 100 / BEFORE))
          
          echo "üìÑ After: $AFTER bytes"
          echo "‚úÖ Saved: $SAVED bytes ($PERCENT%)"
      
      - name: Deploy www/ to MAIN bucket
        env:
          BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_MAIN }}
          ENDPOINT: ${{ secrets.YANDEX_STORAGE_ENDPOINT }}
        run: |
          echo "üì§ Deploying www/ to MAIN bucket: $BUCKET"
          
          aws s3 sync ./www/ s3://${BUCKET}/ \
            --endpoint-url ${ENDPOINT} \
            --delete \
            --exclude ".git*" \
            --exclude ".github*"
          
          echo "‚úÖ Deployment complete"
      
      - name: Verify deployment
        env:
          BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_MAIN }}
          ENDPOINT: ${{ secrets.YANDEX_STORAGE_ENDPOINT }}
        run: |
          echo "üìÅ Contents of MAIN bucket:"
          aws s3 ls s3://${BUCKET}/ \
            --endpoint-url ${ENDPOINT} \
            --recursive \
            --human-readable
      
      - name: Deployment Summary
        env:
          BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_MAIN }}
        run: |
          echo ""
          echo "=========================================="
          echo "üéâ WWW Deployment Complete!"
          echo "=========================================="
          echo "Bucket: $BUCKET"
          echo "Commit: ${{ github.sha }}"
          echo "Date: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
          echo "=========================================="
