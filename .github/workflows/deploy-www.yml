name: Deploy WWW to Main Bucket

on:
  push:
    branches:
      - main
    paths:
      - 'www/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    # Skip if commit message contains [skip ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Install AWS CLI
        run: pip install awscli
      
      - name: Configure AWS CLI for Yandex Cloud
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.YANDEX_STORAGE_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.YANDEX_STORAGE_SECRET_KEY }}
        run: |
          aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          aws configure set default.region ru-central1
      
      - name: Show changed files
        run: |
          echo "ðŸ“ Files in www/:"
          ls -la www/
      
      - name: Minify index.html for deploy
        run: |
          echo "ðŸ”¨ Minifying www/index.html for deploy..."
          
          # Ð Ð°Ð·Ð¼ÐµÑ€ Ð´Ð¾ Ð¼Ð¸Ð½Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
          BEFORE=$(stat -c%s www/index.html)
          echo "ðŸ“„ Before: $BEFORE bytes"
          
          # ÐœÐ¸Ð½Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ HTML (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸, Ð½Ðµ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ð¼)
          npx --yes html-minifier-terser \
            --collapse-whitespace \
            --preserve-line-breaks \
            --remove-comments \
            --remove-redundant-attributes \
            --remove-script-type-attributes \
            --remove-style-link-type-attributes \
            --minify-css true \
            --minify-js true \
            --input-dir www \
            --output-dir www \
            --file-ext html
          
          # Ð Ð°Ð·Ð¼ÐµÑ€ Ð¿Ð¾ÑÐ»Ðµ Ð¼Ð¸Ð½Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
          AFTER=$(stat -c%s www/index.html)
          SAVED=$((BEFORE - AFTER))
          PERCENT=$((SAVED * 100 / BEFORE))
          
          echo "ðŸ“„ After: $AFTER bytes"
          echo "âœ… Saved: $SAVED bytes ($PERCENT%)"
          
          # Ð’ÐÐ–ÐÐž: deploy-www.yml ÐÐ• ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð¸Ñ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ,
          # Ð¿Ð¾ÑÑ‚Ð¾Ð¼Ñƒ Ð¼Ð¸Ð½Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ ÐÐ• Ð¿Ð¾Ð¿Ð°Ð´Ñ‘Ñ‚ Ð² Ñ€ÐµÐ¿Ð¾
      
      - name: Find changed files in www/
        id: changes
        run: |
          echo "ðŸ” Finding changed files in www/..."
          
          # Get changed files (added, modified)
          CHANGED=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} -- www/ 2>/dev/null | grep -v '^$' || true)
          
          # Get deleted files
          DELETED=$(git diff --name-only --diff-filter=D ${{ github.event.before }} ${{ github.sha }} -- www/ 2>/dev/null | grep -v '^$' || true)
          
          # Fallback: if before is empty (first push), compare with HEAD~1
          if [ -z "$CHANGED" ] && [ -z "$DELETED" ]; then
            CHANGED=$(git diff --name-only HEAD~1 HEAD -- www/ 2>/dev/null | grep -v '^$' || true)
            DELETED=$(git diff --name-only --diff-filter=D HEAD~1 HEAD -- www/ 2>/dev/null | grep -v '^$' || true)
          fi
          
          # Save to files for next step
          echo "$CHANGED" > /tmp/changed_files.txt
          echo "$DELETED" > /tmp/deleted_files.txt
          
          echo "ðŸ“ Changed files:"
          cat /tmp/changed_files.txt
          echo ""
          echo "ðŸ—‘ï¸ Deleted files:"
          cat /tmp/deleted_files.txt
          
          # Count files
          if [ -n "$CHANGED" ]; then
            CHANGED_COUNT=$(echo "$CHANGED" | wc -l | tr -d ' ')
          else
            CHANGED_COUNT=0
          fi
          
          if [ -n "$DELETED" ]; then
            DELETED_COUNT=$(echo "$DELETED" | wc -l | tr -d ' ')
          else
            DELETED_COUNT=0
          fi
          
          echo "changed_count=$CHANGED_COUNT" >> $GITHUB_OUTPUT
          echo "deleted_count=$DELETED_COUNT" >> $GITHUB_OUTPUT
      
      - name: Deploy changed files to MAIN bucket
        env:
          BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_MAIN }}
          ENDPOINT: ${{ secrets.YANDEX_STORAGE_ENDPOINT }}
        run: |
          echo "ðŸ“¤ Deploying changed files to MAIN bucket: $BUCKET"
          
          # Upload changed/added files
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            if [ -f "$file" ]; then
              S3_PATH="${file#www/}"
              echo "  ðŸ“„ Uploading: $file â†’ $S3_PATH"
              aws s3 cp "$file" "s3://${BUCKET}/${S3_PATH}" \
                --endpoint-url ${ENDPOINT}
            fi
          done < /tmp/changed_files.txt
          
          # Delete removed files
          while IFS= read -r file; do
            [ -z "$file" ] && continue
            S3_PATH="${file#www/}"
            echo "  ðŸ—‘ï¸ Deleting: $S3_PATH"
            aws s3 rm "s3://${BUCKET}/${S3_PATH}" \
              --endpoint-url ${ENDPOINT} || true
          done < /tmp/deleted_files.txt
          
          echo "âœ… Deployment complete"
      
      - name: Verify deployment
        env:
          BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_MAIN }}
          ENDPOINT: ${{ secrets.YANDEX_STORAGE_ENDPOINT }}
        run: |
          echo "ðŸ“Š Deployment summary:"
          echo "  - Changed files uploaded: ${{ steps.changes.outputs.changed_count }}"
          echo "  - Deleted files removed: ${{ steps.changes.outputs.deleted_count }}"
          echo ""
          echo "ðŸ“ Contents of MAIN bucket:"
          aws s3 ls s3://${BUCKET}/ \
            --endpoint-url ${ENDPOINT} \
            --recursive \
            --human-readable
      
      - name: Deployment Summary
        env:
          BUCKET: ${{ secrets.YANDEX_STORAGE_BUCKET_MAIN }}
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸŽ‰ WWW Deployment Complete!"
          echo "=========================================="
          echo "Bucket: $BUCKET"
          echo "Commit: ${{ github.sha }}"
          echo "Date: $(date -u +%Y-%m-%d\ %H:%M:%S\ UTC)"
          echo "=========================================="
